/*
 * Syntax Diagram Creator
 * 
 * Copyright (c) 2011 Brian Li
 * Licensed under the MIT license.
 */
(function(){var t,k,m,u,r,p,o,q,v,w,x,n,j,s,y;o=function(b){return b instanceof Array};q=function(b){return b!=null&&typeof b==="object"&&!o(b)};v=function(b){return typeof b==="string"};m=function(b,c){return b.split(c).length-1};p=/\&\#(\d+);/g;s=m(document.charset||document.characterSet||"","UTF")>0?function(b,c){var e;e=b.replace(p,function(b,f){var e;e=+f;if(!c)if(e===32)return"\u00abSP\u00bb";else if(e===9)return"\u00abTAB\u00bb";else if(e===10)return"\u00abNL\u00bb";else if(e===13)return"\u00abCR\u00bb";
return String.fromCharCode(e)});return e.match(/^\s*$/)?"\u00ab\u2422\u00bb":e}:function(b,c){var e;e=b.replace(p,function(b,e){var d;d=+e;if(!c)if(d===32)return"<<SP>>";else if(d===9)return"<<TAB>>";else if(d===10)return"<<NL>>";else if(d===13)return"<<CR>>";return String.fromCharCode(d)});return e.match(/^\s*$/)?"<<WHITESPACE>>":e};w=function(b,c){var e,a,f,d;c||(c={next:0});f=c.next;a=b.length;b.charAt(f)===" "&&++f;if(f>=a)return null;for(e=f;e<a;){if((d=b.charAt(e))===" "||d==="("||d===")"||
d==="*"||d==="<"||d===">"||d==="|")break;++e}f===e&&++e;a=b.substring(f,e);return{next:e,word:a}};t=function(b){var c,e;e=b.length;c=function(a,f){var d,g,h,i;h=[];for(d=!!f;a<e;){g=b[a];if(g==="(")g=c(a+1),h.push(g.result),a=g.index;else if(g==="<")if(h.length>0)if(i=h.pop(),q(i))g=c(a+1),a=g.index,i.args||(i.args=[]),i.args.push(g.result),h.push(i);else throw"SyntaxError";else throw"SyntaxError";else if(g==="*")i=h.pop(),h.push({data:i,type:"repeat"}),++a;else if(g==="|")if(i=h.length>0?h.pop():
null,g=c(a+1,!0),a=g.index,q(i)&&i.type!=="repeat"){if(!o(i.data))i.data=[i.data];i.data.push(g.result);h.push(i)}else h.push({data:[i,g.result],type:"or"});else g===")"?d=!0:g===">"?(h.reverse(),d=!0):h.push(b[a]),++a;if(d)break}return{result:h,index:a}};return c(0).result};j=function(b){var c,e,a,f;if(o(b))if(b.length===0)return null;else if(b.length===1)return j(b[0]);else{f=[];c=0;for(e=b.length;c<e;c++)a=b[c],f.push(j(a));return f}else if(q(b)){e={};for(c in b)a=b[c],e[c]=j(a);if(e.type==="repeat"&&
(e.args||(e.args=[null]),!o(e.args)))e.args=[e.args];return[null,e,null]}else return b};x=function(b){var c,e,b=b.replace(/(^|[^\\])#.+/g,"$1").replace(/\\./g,function(b){b=b.charCodeAt(1);b===116?b=9:b===110?b=10:b===114&&(b=13);return"&#"+b+";"}).replace(/\s+/g," ").replace(/\[\s*([^\s\(\)\[\]\*]*)\s*\]/g,"(|$1)").replace(/\[/g,"(|(").replace(/\]/g,"))").replace(/\*+/g,"*");if(m(b,"(")!==m(b,")")||m(b,"<")!==m(b,">"))throw"SyntaxError: unmatched parenthese";c=[];for(e=null;e=w(b,e);)c.push(e.word);
b=null;c[1]===":="&&(b=c.shift(),c.shift());c=t(c);c=j(c);c=o(c)?c:[c];c.push(null);c.unshift(null);return{name:b,syntax:c}};r=function(b,c,e,a,f){f==null&&(f=!1);c=b.text(e,a,c).attr({"font-family":f?"consolas,monospaced":"helvetica,arial","font-style":f?"normal":"italic","font-size":20,"font-weight":f?"normal":"bold","text-anchor":"start"});a=c.getBBox();f=b.rect(a.x-10,a.y-6,a.width+20,a.height+12,f?10:0).attr({fill:"#EEE","stroke-width":4});f.insertBefore(c);b=b.set(f,c);b.translate(e-b.getBBox().x,
0);return b};n=[];k=function(b,c,e,a){var f,d,g,h;a==null&&(a=0);b=c.end;c=e.start;d=Math.abs(c[1]-b[1]);d<1.0E-4&&(a=0);e=function(b,c,e){return[b[0],b[1],c[0],c[1],e[0],e[1]].join(" ")};a===2?(a=[Math.max(b[0]-20,c[0]-20,b[0]),b[1]],g=[a[0]+10,a[1]],f=[Math.max(b[0]-10,c[0]-10,b[0]),b[1]-10],d=[f[0],c[1]+10],h=[d[0],d[1]-10],n.push("M",b.join(" "),"L",a.join(" "),"C",e(g,f,f),"L",d.join(" "),"C",e(h,c,c))):a===-2?(g=[b[0]+10,b[1]],a=[Math.min(b[0]+10,c[0]+10,c[0]),b[1]+10],f=[a[0],Math.max(b[1],
c[1]-10)],h=[f[0],f[1]+10],d=[Math.min(b[0]+20,c[0]+20,c[0]),c[1]],n.push("M",b.join(" "),"C",e(g,a,a),"L",f.join(" "),"C",e(h,d,d),"L",c.join(" "))):a===1?(d*=0.5,a=[Math.max(b[0],c[0]),b[1]],f=[a[0],c[1]],g=[a[0]+d,a[1]],h=[f[0]+d,f[1]],n.push("M",b.join(" "),"L",a.join(" "),"C",e(g,h,f),"L",c.join(" "))):a===-1?(d*=0.5,a=[Math.min(b[0],c[0]),b[1]],f=[a[0],c[1]],g=[a[0]-d,a[1]],h=[f[0]-d,f[1]],n.push("M",b.join(" "),"L",a.join(" "),"C",e(g,h,f),"L",c.join(" "))):n.push("M",b.join(" "),"L",c.join(" "))};
y=function(b,c,e,a){var f,d,g,h,i,m,j,p;i=b.circle(e,a,10).attr({fill:"#FFF",stroke:"#000","stroke-width":4});m=function(c,f){var d,l,g,h,i,j,k,n;if(o(c)){l=b.set();g=0;j=[];f&&(h=e);k=0;for(n=c.length;k<n;k++)d=c[k],i=m(d),d=i.getBBox(),f?(e=h,i.translate(0,g),j.push(d.width),g+=d.height+15):e=d.x+d.width+20,l.push(i);if(f){g=Math.max.apply(Math,j);d=0;for(h=l.items.length;0<=h?d<h:d>h;0<=h?d++:d--)l.items[d].translate(0.5*(g-j[d]),0)}return l}else return q(c)?m(c.args!=null?[c.data,c.args]:c.data,
!0):c!=null?(l=!1,c.match(/^((\".*\")|(\'.*\'))$/)!=null&&(l=!0,c=c.substring(1,c.length-1)),r(b,s(c,!l),e,a,l)):(l=r(b,"-",e,a).attr({opacity:0}),d=l.getBBox(),j=d.y+d.height*0.5,l.push(b.path("M"+d.x+" "+j+"L"+(d.x+d.width)+" "+j).attr({"stroke-width":4,"stroke-linecap":"round"})),l)};j=function(c,e,f){var a,d,g,h,i;if(o(c)){d=[];a=0;for(g=c.length;0<=g?a<g:a>g;0<=g?a++:a--)d.push(j(c[a],e[a],a>0?d[a-1]:f));a=0;for(h=c.length-1;0<=h?a<h:a>h;0<=h?a++:a--)if(k(b,d[a],d[a+1]),d[a].or!=null){i=d[a].or;
f=0;for(g=i.length;f<g;f++)e=i[f],k(b,e,d[a+1],2)}return{start:d[0].start,end:d[c.length-1].end}}else if(q(c))if(c.type==="or"){d=[];g=[];a=0;for(h=c.data.length;0<=h?a<h:a>h;0<=h?a++:a--)d.push(j(c.data[a],e[a],a>0?d[a-1]:f)),k(b,f,d[a],-2),g.push(d[a]);g.shift();d[0].or=g;return d[0]}else{if(c.type==="repeat"){c=[c.data,c.args];d=[];a=0;for(g=c.length;0<=g?a<g:a>g;0<=g?a++:a--)d.push(j(c[a],e[a],f)),a>0&&(k(b,{end:d[0].end},{start:d[a].end},1),k(b,{end:d[0].start},{start:d[a].start},-1));return d[0]}}else return a=
e.getBBox(),d=a.y+a.height*0.5,{start:[a.x,d],end:[a.x+a.width,d]}};h=m(c);d=j(c,h);f=h.getBBox();e=f.x+f.width;c=b.circle(e,a,10).attr({fill:"#FFF",stroke:"#000","stroke-width":4});g=f.height+f.y+5;f=c.getBBox();p=f.width+f.x+16;k(b,d,{start:[f.x,f.y+f.height*0.5]});f=i.getBBox();k(b,{end:[f.x+f.width,f.y+f.height*0.5]},d);i.toFront();f=b.path(n.join("")).attr({"stroke-width":4,"stroke-linecap":"butt"}).toBack();n=[];return{width:p,height:g,all:b.set(h,f,i,c)}};u=function(b,c){var e,a,f,d,g,h,i;
b.innerHTML="";f=Raphael(b,b.offsetWidth,b.offsetHeight);h=g=a=0;for(i=c.length;h<i;h++)d=c[h],e=y(f,d.syntax,30,d.name?55:30),e.all.translate(0,a),d.name&&f.text(10,16,s(d.name,!0)).attr({"font-family":"helvetica,arial","font-style":"italic","font-size":24,"font-weight":"bold","text-anchor":"start"}).translate(0,a),a+=e.height,g=Math.max(g,e.width);f.setSize(g,a);return e};window.SyntaxDiagram=function(b,c){var e,a,f,d,g;a=[];g=c.split("====\n");f=0;for(d=g.length;f<d;f++)e=g[f],a.push(x(e));v(b)&&
(b=document.getElementById(b));return u(b,a)}}).call(this);
